И еще один маленький графический
сюжет — это ROC кривая.
Когда мы спрогнозировали вероятность,
у нас получились числа от 0 до 1.
Но при этом, когда нас просят
сделать конкретный прогноз,
так выживет человек или нет, то мы
можем установить любой порог отсечения.
Мы не обязаны поступать по принципу: если
спрогнозируемая вероятность больше 0.5,
то мы прогнозируем, что он выживет; если
спрогнозируемая вероятность меньше 0.5,
то он погибнет.
Мы можем установить любой порог отсечения,
скажем, сказать, что для тех пассажиров, у
которых прогнозная вероятность больше 0.4,
мы будем прогнозировать таких выжившими.
Порог прогнозирования мы выбираем сами.
Естественно, выбор порога,
начиная с которого
мы считаем людей выжившими,
он влияет на вероятность разных ошибок.
Давайте посмотрим, что будет происходить,
если мы будем устанавливать разные пороги.
Для начала спрогнозируем вероятности
не для выдуманного нами набора
данных new data,
а для исходного набора данных t.
Соответственно, прогнозы для
набора данных t, это predict,
мы используем оцененную нами логит модель,
на наборе данных t прогнозируем,
и для надежности попросим, чтобы
компьютер выдал нам стандартные ошибки.
Я напомню, что команда predict по
умолчанию прогнозирует значение скрытой
переменной, и ее необходимо дополнительно…
применить к ней логистическую функцию
распределения, чтобы получить
прогнозные вероятности.
Соответственно, мы подкрепим
новые столбики к табличке t.
cbind к табличке t подкрепляем
наши новые столбики.
Теперь превращаем оцененные
значения скрытой переменной к...
превращаем их в вероятности.
t = mutate t и вероятность
мы оцениваем как логистическую функцию
распределения plogis в точке fit.
Соответственно, для наглядности
давайте посмотрим на начало таблички.
select от t,
выберем возраст,
выжил ли по факту пассажир или нет,
и наши спрогнозированные вероятности.
Вот у нас видно всю табличку.
У кого-то вероятность не спрогнозирована,
потому что не хватает наблюдений.
По остальным у нас есть возраст,
фактическое значение переменной выжил/ не
выжил и спрогнозированная вероятность.
Например, вот этот пассажир,
1300-й, он не выжил.
Спрогнозированная вероятность
для него равна 0.1.
1301-й — по факту он выжил.
Спрогнозированная вероятность
для него была равна 0.67.
Теперь на основании этих
данных мы переберем разные
пороги отсечения и посмотрим,
как влияет порог отсечения
на вероятность неправильной
классификации пассажира.
Соответственно, мы построим
так называемую ROC кривую.
Сначала соберем для нее данные.
roc.data равняется roc кривая...
Нам из таблички t нужна
вероятность «выжить»
и из таблички t нам нужны фактические
значения переменной survived.
Теперь у нас получился
список из трех переменных.
Давайте на него посмотрим.
Здесь присутствует в этом списке три
переменных: cutoffs — это компьютер
сам перебрал все возможные пороги
отсечения: 0,97; 0,955; 0,954.
То есть это граница,
за которой мы признаем пассажира выжившим.
fpr — это false positive rate — это,
соответственно,
доля ошибочно классифицированных
не выживших пассажиров.
И true positive rate (tpr) — это
доля верно классифицированных
выживших пассажиров.
Давайте посмотрим,
как выглядят эти показатели на графике.
qplot, по горизонтали мы отложим
roc.data переменную «порог» (cutoffs),
а по вертикали отложим из этого
набора данных переменную,
скажем, tpr и укажем тип графика
— линия.
Увеличим график.
По горизонтали на графике отмечены
возможные пороги отсечения,
а по вертикали отмечен показатель
tpr (true positive rate),
то есть в нашем случае это доля верно
классифицированных выживших пассажиров.
Соответственно, если я выбираю низкий
порог отсечения, например, 0.25,
это означает, что я большое количество
пассажиров прогнозирую выжившими,
потому что как только прогнозная
вероятность оказывается больше 0.25,
я считаю, что он выжил.
Соответственно, в таком случае доля
верно классифицированных выживших
пассажиров оказывается
высокой — около 0.75.
Однако если я выбираю
высокий порог отсечения,
скажем, 0.75, то это означает,
что я существенно реже буду
прогнозировать пассажира как выжившего,
и поэтому доля верно классифицированных
выживших пассажиров будет ниже — 
порядка 0.4, судя по графику.
Аналогично поступим и посмотрим
на график: доля неверно
классифицированных не выживших пассажиров.
Для этого строим график.
По горизонтали откладываем
по-прежнему пороги отсечения,
а по вертикали fpr (false positive rate),
то есть долю неверно классифицированных
не выживших пассажиров.
Увеличиваем график и видим: по горизонтали
у нас возможные пороги отсечения,
а по вертикали – доля неверно
классифицированных не выживших пассажиров.
То есть если я выбираю очень маленький
порог отсечения, скажем,
близко к нулю, то есть это означает, что
я всех пассажиров прогнозирую выжившими.
При этом у меня доля неверно
классифицированных не выживших пассажиров
будет достаточно высокой,
поскольку я всех прогнозирую выжившими.
И очень часто строят сочетание
этих двух графиков на одном,
который называется,
собственно, ROC кривой.
Для этого по горизонтали
откладывают из нашего
набора данных откладывают
fpr — false positive rate,
а по вертикали откладывают,
соответственно, true positive rate.
И укажем тип графика — линия.
Соответственно, этот график
показывает дилемму выбора между верно
классифицированными погибшими
пассажирами и
верно классифицированными
выжившими пассажирами.
Если я устанавливаю высокий порог
отсечения, то, соответственно,
у меня будет низкая доля верно
классифицированных выживших пассажиров,
но высокая доля верно классифицированных
не выживших пассажиров.
И наоборот, если я устанавливаю
низкий порог отсечения,
я всех пассажиров прогнозирую,
что они выживают, соответственно,
доля верно угаданных выживших
пассажиров у меня близка к 1,
но близка к 1 и доля неверно
угаданных не выживших пассажиров.
На примере набора данных о пассажирах
«Титаника» мы с вами разобрали задачу
оценки логит модели,
интерпретации коэффициентов,
расчет предельных эффектов
и задачу прогнозирования.
Нам повезло и мы не столкнулись, например,
с проблемой разделения набора данных,
которая была упомянута в лекции.

